<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OctoNote 🐙</title>
<style>
body { margin:0; font-family:sans-serif; background:#f7f7f7; }
#ribbon { display:flex; padding:5px; background:#eee; border-bottom:1px solid #ccc; }
#ribbon button { margin:0 4px; padding:6px 10px; cursor:pointer; }
#pages { position:relative; width:100%; height:calc(100vh - 50px); overflow:hidden; display:flex; justify-content:center; align-items:center; }
.page { position:relative; width:800px; height:1000px; background:white; box-shadow:0 0 10px rgba(0,0,0,0.1); }
canvas { position:absolute; top:0; left:0; }
.layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
img, .text { position:absolute; cursor:move; }
#tools { position:fixed; top:60px; right:10px; background:#fff; border:1px solid #ccc; padding:10px; border-radius:5px; }
#tools input[type=color], #tools input[type=number] { margin:4px; }
</style>
</head>
<body>

<div id="ribbon">
  <button onclick="addPage()">➕ Neue Seite</button>
  <button onclick="prevPage()">⬅️</button>
  <button onclick="nextPage()">➡️</button>
  <button onclick="toggleGrid()">📏 Raster</button>
  <button onclick="undo()">↩️ Undo</button>
  <button onclick="redo()">↪️ Redo</button>
  <button onclick="saveONNB()">💾 Speichern (.onnb)</button>
  <button onclick="openONNB()">📂 Öffnen (.onnb)</button>
  <button onclick="exportPDF()">🖨️ Export PDF</button>
</div>

<div id="pages"></div>

<div id="tools">
  <label>Farbe: <input type="color" id="drawColor" value="#000000"></label>
  <label>Größe: <input type="number" id="drawSize" value="3" min="1" max="20"></label>
  <button onclick="startDrawingMode()">✏️ Zeichnen</button>
  <button onclick="addText()">📝 Text</button>
  <button onclick="addEmoji()">😀 Emoji</button>
  <button onclick="addImage()">🖼️ Bild</button>
</div>

<input type="file" id="fileInput" hidden>

<script>
let pages=[]; let currentPage=-1; let drawing=false,lastX=0,lastY=0,grid=false;
let undoStack=[],redoStack=[];

// --- Seitenverwaltung ---
function addPage(){
  const pageDiv=document.createElement('div'); pageDiv.className='page';
  const canvas=document.createElement('canvas'); canvas.width=800; canvas.height=1000; canvas.className='canvas';
  const ctx=canvas.getContext('2d'); pageDiv.appendChild(canvas);
  pages.push({canvas:canvas,ctx:ctx,layers:[],history:[],redoHistory:[]});
  document.getElementById('pages').innerHTML=''; document.getElementById('pages').appendChild(pageDiv);
  currentPage=pages.length-1; drawGrid();
}

function prevPage(){ if(currentPage>0){ savePage(); currentPage--; loadPage(); } }
function nextPage(){ if(currentPage<pages.length-1){ savePage(); currentPage++; loadPage(); } }

function loadPage(){
  const page=pages[currentPage];
  const pageDiv=document.createElement('div'); pageDiv.className='page';
  pageDiv.appendChild(page.canvas);
  document.getElementById('pages').innerHTML=''; document.getElementById('pages').appendChild(pageDiv);
  redrawCanvas(); drawGrid();
}

function savePage(){
  const page=pages[currentPage];
  page.savedData=page.canvas.toDataURL();
}

function redrawCanvas(){
  const page=pages[currentPage];
  const ctx=page.ctx; ctx.clearRect(0,0,800,1000);
  if(page.savedData){ const img=new Image(); img.src=page.savedData; img.onload=()=>ctx.drawImage(img,0,0); }
}
</script>
<script>
// --- Zeichnen ---
function startDrawingMode(){
  const page=pages[currentPage]; 
  const canvas=page.canvas;
  canvas.style.pointerEvents='auto';
  
  canvas.onmousedown=e=>{
    drawing=true;
    lastX=e.offsetX; lastY=e.offsetY;
    // Undo speichern
    page.history.push(canvas.toDataURL());
    page.redoHistory=[];
  };
  
  canvas.onmouseup=e=>{ drawing=false; };
  
  canvas.onmousemove=e=>{
    if(!drawing) return;
    const ctx=page.ctx;
    ctx.strokeStyle=document.getElementById('drawColor').value;
    ctx.lineWidth=parseInt(document.getElementById('drawSize').value);
    ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
    lastX=e.offsetX; lastY=e.offsetY;
  };
}

// --- Undo / Redo ---
function undo(){
  const page=pages[currentPage];
  if(page.history.length===0) return;
  const last=page.history.pop();
  page.redoHistory.push(page.canvas.toDataURL());
  const img=new Image(); img.src=last;
  img.onload=()=>page.ctx.drawImage(img,0,0);
}

function redo(){
  const page=pages[currentPage];
  if(page.redoHistory.length===0) return;
  const next=page.redoHistory.pop();
  page.history.push(page.canvas.toDataURL());
  const img=new Image(); img.src=next;
  img.onload=()=>page.ctx.drawImage(img,0,0);
}
</script>
<script>
// --- Raster / Karo / Notenlinien ---
function toggleGrid(){
  grid=!grid; drawGrid();
}

function drawGrid(){
  const page=pages[currentPage]; if(!page) return;
  const ctx=page.ctx;
  // Hintergrund wiederherstellen
  redrawCanvas();
  if(!grid) return;
  
  const spacing=40; // Standard Rastergröße
  ctx.strokeStyle='#eee';
  ctx.lineWidth=1;
  
  // Vertikale Linien
  for(let x=0;x<800;x+=spacing){
    ctx.beginPath();
    ctx.moveTo(x,0); ctx.lineTo(x,1000); ctx.stroke();
  }
  // Horizontale Linien
  for(let y=0;y<1000;y+=spacing){
    ctx.beginPath();
    ctx.moveTo(0,y); ctx.lineTo(800,y); ctx.stroke();
  }
}

// --- Karo / Notenlinien anpassen ---
function setGridSpacing(value){
  const page=pages[currentPage]; if(!page) return;
  page.gridSpacing=parseInt(value);
  drawCustomGrid();
}

function drawCustomGrid(){
  const page=pages[currentPage]; if(!page) return;
  redrawCanvas();
  if(!grid) return;
  
  const spacing=page.gridSpacing || 40;
  const ctx=page.ctx; ctx.strokeStyle='#eee'; ctx.lineWidth=1;
  
  for(let x=0;x<800;x+=spacing){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,1000); ctx.stroke();
  }
  for(let y=0;y<1000;y+=spacing){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(800,y); ctx.stroke();
  }
}

// --- Notenlinien Beispiel ---
function drawStaffLines(lines=5, lineSpacing=20, offsetY=100){
  const page=pages[currentPage]; if(!page) return;
  const ctx=page.ctx; ctx.strokeStyle='#000'; ctx.lineWidth=1;
  for(let i=0;i<lines;i++){
    const y=offsetY+i*lineSpacing;
    ctx.beginPath(); ctx.moveTo(50,y); ctx.lineTo(750,y); ctx.stroke();
  }
}
</script>
<script>
// --- Elemente hinzufügen ---
function addText(){
  const txt=document.createElement('div');
  txt.className='text'; txt.contentEditable=true;
  txt.style.left='100px'; txt.style.top='100px';
  txt.style.fontSize='20px'; txt.style.color='#000';
  txt.textContent='📝 Neuer Text';
  makeDraggable(txt); pages[currentPage].canvas.parentElement.appendChild(txt);
}

function addEmoji(){
  const emoji=document.createElement('div');
  emoji.className='text'; emoji.contentEditable=true;
  emoji.style.left='150px'; emoji.style.top='150px'; emoji.style.fontSize='30px';
  emoji.textContent='😀';
  makeDraggable(emoji); pages[currentPage].canvas.parentElement.appendChild(emoji);
}

function addImage(){
  const url=prompt("Bild-URL eingeben:");
  if(!url) return;
  const img=document.createElement('img'); img.src=url;
  img.style.left='200px'; img.style.top='200px'; img.style.width='150px';
  makeDraggable(img); pages[currentPage].canvas.parentElement.appendChild(img);
}

// --- Drag & Drop ---
function makeDraggable(el){
  el.onmousedown=function(e){
    let offsetX=e.offsetX, offsetY=e.offsetY;
    function move(ev){
      el.style.left=ev.pageX-offsetX+'px';
      el.style.top=ev.pageY-offsetY+'px';
    }
    document.addEventListener('mousemove',move);
    document.onmouseup=function(){ document.removeEventListener('mousemove',move); document.onmouseup=null; };
  }
}

// --- ONNB speichern/laden ---
function saveONNB(){
  const data={pages:[]};
  pages.forEach(p=>{
    data.pages.push({canvas:p.canvas.toDataURL(),layers:[]});
  });
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='OctoNote.onnb'; a.click();
}

function openONNB(){
  const input=document.getElementById('fileInput'); input.accept='.onnb'; input.click();
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const data=JSON.parse(ev.target.result);
      pages=[]; document.getElementById('pages').innerHTML='';
      data.pages.forEach(d=>{
        addPage(); pages[pages.length-1].canvas.getContext('2d').drawImage(new Image(){src=d.canvas},0,0);
      });
    }; reader.readAsText(file);
  }
}

// --- PDF Export (einfach) ---
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF('p','px','a4');
  pages.forEach((p,i)=>{
    pdf.addImage(p.canvas.toDataURL(),'PNG',0,0,595,842);
    if(i<pages.length-1) pdf.addPage();
  });
  pdf.save('OctoNote.pdf');
}
</script>

<!-- jsPDF CDN für PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
