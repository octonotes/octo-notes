<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OctoNotes+ v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&family=Montserrat&family=Lato&family=Open+Sans&family=Oswald&family=PT+Sans&family=Raleway&family=Source+Sans+Pro&family=Ubuntu&family=Playfair+Display&family=Merriweather&family=Inconsolata&family=Pacifico&family=Fira+Sans&family=Roboto+Slab&display=swap" rel="stylesheet">

<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#f5f7fb; color:#222; display:flex; flex-direction:column; height:100vh;}
button, select, input, textarea { font-family: inherit; cursor:pointer; }
#ribbon { display:flex; flex-direction:column; background:linear-gradient(180deg,#fafbfd 0%,#eef3fb 100%); border-bottom:1px solid #cfd6e3; box-shadow:0 2px 6px rgba(20,30,50,0.05); position:sticky; top:0; z-index:100; }
#ribbon-tabs { display:flex; gap:4px; padding:4px 8px; border-bottom:1px solid #d5d9e3; background:#f9f9fc; }
#ribbon-tabs .tab { background:none; border:none; padding:6px 12px; border-radius:6px 6px 0 0; transition:all 0.15s ease; font-weight:500; }
#ribbon-tabs .tab:hover { background:#e9edf6; }
#ribbon-tabs .tab.active { background:#fff; border:1px solid #d5d9e3; border-bottom:none; color:#222; font-weight:600; }
#ribbon-groups { display:flex; gap:10px; padding:8px 12px; background:#fff; border-top:1px solid #e3e7ef; flex-wrap:wrap; }
.ribbon-group { display:flex; align-items:center; gap:8px; }
.hidden { display:none; }

#notebook { flex:1; overflow:auto; padding:20px; display:flex; flex-direction:column; align-items:center; }
.page { position:relative; background:#fff; box-shadow:0 0 6px rgba(0,0,0,0.1); width:800px; height:1100px; margin:20px auto; border-radius:6px; overflow:hidden; }
canvas.drawing { position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none; }
.page.bg-lined::before, .page.bg-grid::before, .page.bg-dots::before, .page.bg-music::before { content:""; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; background-size:var(--pattern-size,30px) var(--pattern-size,30px); opacity:0.3; }
.page.bg-lined::before { background-image:linear-gradient(#8aaaf5 1px, transparent 1px); }
.page.bg-grid::before { background-image:linear-gradient(#9bc4f5 1px, transparent 1px), linear-gradient(90deg, #9bc4f5 1px, transparent 1px); }
.page.bg-dots::before { background-image:radial-gradient(#9bc4f5 1px, transparent 1px); }
.page.bg-music::before { background-image:repeating-linear-gradient(#000 0, #000 1px, transparent 1px, transparent 20px); }

.note-text { position:absolute; background:transparent; border:none; resize:none; font-size:16px; outline:none; width:300px; height:100px; }
img.draggable { position:absolute; max-width:300px; cursor:move; transform-origin:center center; transition:transform 0.1s ease; }
</style>
</head>
<body>

<header id="ribbon">
  <div id="ribbon-tabs">
    <button class="tab active" data-tab="file">ğŸ“ Datei</button>
    <button class="tab" data-tab="home">ğŸ  Start</button>
    <button class="tab" data-tab="insert">â• EinfÃ¼gen</button>
    <button class="tab" data-tab="draw">ğŸ–Šï¸ Zeichnen</button>
    <button class="tab" data-tab="view">ğŸ‘ï¸ Ansicht</button>
  </div>

  <div id="ribbon-groups">
    <div class="ribbon-group" id="tab-file">
      <button onclick="saveONNB()">ğŸ’¾ Speichern</button>
      <button onclick="exportPDF()">ğŸ“¤ PDF</button>
      <button onclick="openONNB()">ğŸ“‚ Ã–ffnen</button>
      <button onclick="printNote()">ğŸ–¨ï¸ Drucken</button>
    </div>

    <div class="ribbon-group hidden" id="tab-home">
      <button onclick="addPage()">ğŸ“„ Neue Seite</button>
      <button onclick="addText()">ğŸ“ Textfeld</button>
      <button onclick="deletePage()">ğŸ—‘ï¸ Seite lÃ¶schen</button>
      <select id="fontFamily" onchange="setFont(this.value)">
        <option value="sans-serif">System</option>
        <option value="Roboto">Roboto</option>
        <option value="Montserrat">Montserrat</option>
        <option value="Lato">Lato</option>
        <option value="Open Sans">Open Sans</option>
        <option value="Oswald">Oswald</option>
        <option value="PT Sans">PT Sans</option>
        <option value="Raleway">Raleway</option>
        <option value="Source Sans Pro">Source Sans Pro</option>
        <option value="Ubuntu">Ubuntu</option>
        <option value="Playfair Display">Playfair Display</option>
        <option value="Merriweather">Merriweather</option>
        <option value="Inconsolata">Inconsolata</option>
        <option value="Pacifico">Pacifico</option>
        <option value="Fira Sans">Fira Sans</option>
        <option value="Roboto Slab">Roboto Slab</option>
      </select>
      <select id="fontSize" onchange="setFontSize(this.value)">
        <option value="12">12px</option>
        <option value="14" selected>14px</option>
        <option value="16">16px</option>
        <option value="18">18px</option>
        <option value="20">20px</option>
        <option value="24">24px</option>
        <option value="28">28px</option>
      </select>
      <button onclick="toggleStyle('bold')">B</button>
      <button onclick="toggleStyle('italic')">I</button>
      <button onclick="toggleStyle('underline')">U</button>
    </div>

    <div class="ribbon-group hidden" id="tab-insert">
      <button onclick="triggerFile()">ğŸ–¼ï¸ Bild einfÃ¼gen</button>
      <input type="file" id="imgInput" accept="image/*" hidden>
    </div>

    <div class="ribbon-group hidden" id="tab-draw">
      <label>Farbe <input type="color" id="color" value="#000000"></label>
      <label>StÃ¤rke <input type="range" id="size" min="1" max="15" value="3"></label>
      <button onclick="setTool('pen')">ğŸ–Šï¸ Stift</button>
      <button onclick="setTool('marker')">ğŸ–ï¸ Marker</button>
      <button onclick="setTool('eraser')">ğŸ©¹ Radierer</button>
    </div>

    <div class="ribbon-group hidden" id="tab-view">
      <select id="bgSelect" onchange="changeBG(this.value)">
        <option value="blank">Leer</option>
        <option value="lined">Liniert</option>
        <option value="grid">Kariert</option>
        <option value="dots">Punktiert</option>
        <option value="music">Notenlinien</option>
      </select>
      <input type="range" min="10" max="50" value="30" id="bgSize" onchange="changePatternSize(this.value)">
    </div>
  </div>
</header>

<main id="notebook"></main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // --- Globals ---
let notebook = document.getElementById("notebook");
let activePage = null;
let tool = "pen";
let colorPicker = document.getElementById("color");
let sizePicker = document.getElementById("size");
let zoomLevel = 1;
let activeText = null;

// --- Init ---
function init() {
  addPage();
  setupRibbonTabs();
  loadFromURL();
}
window.addEventListener("DOMContentLoaded", init);

// --- Ribbon Tabs ---
function setupRibbonTabs() {
  const tabs = document.querySelectorAll("#ribbon-tabs .tab");
  const groups = document.querySelectorAll(".ribbon-group");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      groups.forEach(g => g.classList.add("hidden"));
      const target = document.getElementById("tab-" + tab.dataset.tab);
      if (target) target.classList.remove("hidden");
    });
  });

  // Ersten Tab aktivieren
  tabs[0].classList.add("active");
  groups.forEach(g => g.classList.add("hidden"));
  const firstGroup = document.getElementById("tab-" + tabs[0].dataset.tab);
  if (firstGroup) firstGroup.classList.remove("hidden");
}

// --- Seiten ---
function addPage() {
  const page = document.createElement("div");
  page.className = "page bg-lined";
  const canvas = document.createElement("canvas");
  canvas.className = "drawing";
  canvas.width = 800; canvas.height = 1100;
  page.appendChild(canvas);
  notebook.appendChild(page);

  page.dataset.index = notebook.children.length - 1;
  setupDrawing(canvas);
  setActivePage(page);
}

function deletePage() {
  if (!activePage) return;
  const idx = parseInt(activePage.dataset.index);
  activePage.remove();

  [...notebook.children].forEach((p, i) => p.dataset.index = i);
  if (notebook.children[idx]) setActivePage(notebook.children[idx]);
  else if (notebook.children[idx - 1]) setActivePage(notebook.children[idx - 1]);
  else addPage();
}

function setActivePage(page) {
  if (activePage) activePage.style.border = "none";
  activePage = page;
  activePage.style.border = "2px solid #0078D7";
}

// --- Zeichnen ---
function setupDrawing(canvas) {
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let lastX = 0, lastY = 0;

  function getCursorPos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
  }

  function startDraw(e) {
    drawing = true;
    const pos = getCursorPos(e);
    lastX = pos.x; lastY = pos.y;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
  }

  function draw(e) {
    if (!drawing) return;
    const pos = getCursorPos(e);

    ctx.lineCap = "round";
    ctx.lineWidth = sizePicker.value;
    ctx.globalAlpha = tool === "marker" ? 0.3 : 1;

    if (tool === "eraser") {
      ctx.globalCompositeOperation = "destination-out";
      ctx.strokeStyle = "rgba(0,0,0,1)";
      ctx.shadowBlur = 0;
    } else {
      ctx.globalCompositeOperation = "source-over";
      ctx.strokeStyle = colorPicker.value;
      ctx.shadowBlur = tool === "marker" ? 5 : 0;
      ctx.shadowColor = colorPicker.value;
    }

    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x; lastY = pos.y;
  }

  function stopDraw() {
    drawing = false;
    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = "source-over";
    ctx.shadowBlur = 0;
  }

  canvas.addEventListener("pointerdown", startDraw);
  canvas.addEventListener("pointermove", draw);
  canvas.addEventListener("pointerup", stopDraw);
  canvas.addEventListener("pointerleave", stopDraw);
  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", stopDraw);
}

// --- Tools ---
function setTool(t) { tool = t; }

// --- Textfelder ---
function addText() {
  if (!activePage) return;
  const t = document.createElement("textarea");
  t.className = "note-text";
  t.style.left = "100px"; t.style.top = "100px";
  t.style.fontFamily = document.getElementById("fontFamily").value;
  t.style.fontSize = document.getElementById("fontSize").value + "px";
  activePage.appendChild(t);
  t.focus();
  activeText = t;

  t.addEventListener("focus", ()=>activeText=t);
  t.addEventListener("blur", ()=>activeText=null);
}

// --- Textformatierung ---
function setFont(font) { if(activeText) activeText.style.fontFamily=font; }
function setFontSize(size) { if(activeText) activeText.style.fontSize=size+"px"; }
function toggleStyle(style) {
  if(!activeText) return;
  if(style==="bold") activeText.style.fontWeight = activeText.style.fontWeight==="bold"?"normal":"bold";
  if(style==="italic") activeText.style.fontStyle = activeText.style.fontStyle==="italic"?"normal":"italic";
  if(style==="underline") activeText.style.textDecoration = activeText.style.textDecoration==="underline"?"none":"underline";
}

// --- Bilder ---
function triggerFile() { document.getElementById("imgInput").click(); }
document.getElementById("imgInput").onchange = e => {
  const file = e.target.files[0]; if (!file) return;
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.className = "draggable";
  img.style.left = "150px"; img.style.top = "150px";
  activePage.appendChild(img);
  makeDraggable(img);
};

function makeDraggable(el) {
  let pos={x:0,y:0,startX:0,startY:0};
  function startDrag(e){
    e.preventDefault();
    const evt = e.touches ? e.touches[0] : e;
    pos.startX = evt.clientX; pos.startY = evt.clientY;
    document.addEventListener(e.touches?"touchmove":"mousemove", drag);
    document.addEventListener(e.touches?"touchend":"mouseup", stopDrag);
  }
  function drag(e){
    e.preventDefault();
    const evt = e.touches ? e.touches[0] : e;
    const dx = evt.clientX - pos.startX;
    const dy = evt.clientY - pos.startY;
    pos.startX = evt.clientX; pos.startY = evt.clientY;
    el.style.top = (el.offsetTop + dy) + "px";
    el.style.left = (el.offsetLeft + dx) + "px";
  }
  function stopDrag(){
    document.removeEventListener("mousemove", drag);
    document.removeEventListener("mouseup", stopDrag);
    document.removeEventListener("touchmove", drag);
    document.removeEventListener("touchend", stopDrag);
  }
  el.addEventListener("mousedown", startDrag);
  el.addEventListener("touchstart", startDrag);
}

// --- Hintergrund ---
function changeBG(type) {
  if (!activePage) return;
  activePage.classList.remove("bg-lined","bg-grid","bg-dots","bg-music");
  if(type==="lined") activePage.classList.add("bg-lined");
  else if(type==="grid") activePage.classList.add("bg-grid");
  else if(type==="dots") activePage.classList.add("bg-dots");
  else if(type==="music") activePage.classList.add("bg-music");
}
function changePatternSize(v) { if(activePage) activePage.style.setProperty("--pattern-size",v+"px"); }
  // --- ONNB Save & Load ---
function saveONNB() {
  const data = { pages: [] };
  document.querySelectorAll(".page").forEach(page => {
    const canvas = page.querySelector("canvas.drawing");
    const imgData = canvas.toDataURL();
    const texts = [];
    page.querySelectorAll("textarea.note-text").forEach(t => {
      texts.push({
        value: t.value,
        left: t.style.left,
        top: t.style.top,
        width: t.style.width,
        height: t.style.height,
        fontSize: t.style.fontSize,
        fontFamily: t.style.fontFamily,
        fontWeight: t.style.fontWeight,
        fontStyle: t.style.fontStyle,
        textDecoration: t.style.textDecoration
      });
    });
    const images = [];
    page.querySelectorAll("img.draggable").forEach(im => {
      images.push({
        src: im.src,
        left: im.style.left,
        top: im.style.top,
        width: im.width,
        height: im.height
      });
    });
    data.pages.push({ imgData, texts, images, bg: page.className });
  });
  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "OctoNote.onnb";
  a.click();
}

function openONNB() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".onnb";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const data = JSON.parse(ev.target.result);
      notebook.innerHTML = "";
      data.pages.forEach(p => {
        const page = document.createElement("div");
        page.className = p.bg;
        const canvas = document.createElement("canvas");
        canvas.className = "drawing";
        canvas.width = 800;
        canvas.height = 1100;
        page.appendChild(canvas);
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src = p.imgData;
        img.onload = () => ctx.drawImage(img, 0, 0);
        p.texts.forEach(t => {
          const ta = document.createElement("textarea");
          ta.className = "note-text";
          ta.value = t.value;
          ta.style.left = t.left;
          ta.style.top = t.top;
          ta.style.width = t.width;
          ta.style.height = t.height;
          ta.style.fontSize = t.fontSize;
          ta.style.fontFamily = t.fontFamily;
          ta.style.fontWeight = t.fontWeight;
          ta.style.fontStyle = t.fontStyle;
          ta.style.textDecoration = t.textDecoration;
          page.appendChild(ta);
        });
        p.images.forEach(im => {
          const image = new Image();
          image.src = im.src;
          image.className = "draggable";
          image.style.left = im.left;
          image.style.top = im.top;
          page.appendChild(image);
          makeDraggable(image);
        });
        notebook.appendChild(page);
        setupDrawing(canvas);
      });
      if (notebook.children[0]) setActivePage(notebook.children[0]);
    };
    reader.readAsText(file);
  };
  input.click();
}

// --- PDF Export ---
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "px", format: [800, 1100] });
  const pages = document.querySelectorAll(".page");

  for (let i = 0; i < pages.length; i++) {
    const canvasEl = document.createElement("canvas");
    canvasEl.width = 800;
    canvasEl.height = 1100;
    const tctx = canvasEl.getContext("2d");
    const page = pages[i];
    const canvas = page.querySelector("canvas.drawing");
    tctx.drawImage(canvas, 0, 0);

    page.querySelectorAll("textarea.note-text").forEach(t => {
      tctx.font = `${parseInt(t.style.fontSize || 16)}px ${t.style.fontFamily || "sans-serif"}`;
      tctx.fillStyle = "#000";
      if (t.style.fontWeight === "bold") tctx.font = "bold " + tctx.font;
      if (t.style.fontStyle === "italic") tctx.font = "italic " + tctx.font;
      t.value.split("\n").forEach((line, j) =>
        tctx.fillText(line, parseInt(t.style.left), parseInt(t.style.top) + 16 * (j + 1))
      );
    });

    page.querySelectorAll("img.draggable").forEach(im =>
      tctx.drawImage(im, parseInt(im.style.left), parseInt(im.style.top), im.width, im.height)
    );

    const imgData = canvasEl.toDataURL("image/png");
    if (i > 0) pdf.addPage();
    pdf.addImage(imgData, "PNG", 0, 0, 800, 1100);
  }

  pdf.save("OctoNote.pdf");
}

// --- Drucken ---
function printNote() {
  const w = window.open();
  w.document.write(notebook.innerHTML);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}

// --- AutoSave ---
function autoSave() {
  const data = { pages: [] };
  document.querySelectorAll(".page").forEach(page => {
    const canvas = page.querySelector("canvas.drawing");
    const imgData = canvas.toDataURL();
    const texts = [];
    page.querySelectorAll("textarea.note-text").forEach(t => {
      texts.push({
        value: t.value,
        left: t.style.left,
        top: t.style.top,
        width: t.style.width,
        height: t.style.height,
        fontSize: t.style.fontSize,
        fontFamily: t.style.fontFamily,
        fontWeight: t.style.fontWeight,
        fontStyle: t.style.fontStyle,
        textDecoration: t.style.textDecoration
      });
    });
    const images = [];
    page.querySelectorAll("img.draggable").forEach(im =>
      images.push({ src: im.src, left: im.style.left, top: im.style.top, width: im.width, height: im.height })
    );
    data.pages.push({ imgData, texts, images, bg: page.className });
  });
  localStorage.setItem(`octonote-${notebook.dataset.id || "default"}`, JSON.stringify(data));
}
setInterval(autoSave, 5000);

// --- Load from URL ---
function loadFromURL() {
  const path = window.location.pathname.split("/");
  const id = path[path.length - 1] || "default";
  notebook.dataset.id = id;
  const saved = localStorage.getItem(`octonote-${id}`);
  if (saved) {
    const data = JSON.parse(saved);
    notebook.innerHTML = "";
    data.pages.forEach(p => {
      const page = document.createElement("div");
      page.className = p.bg;
      const canvas = document.createElement("canvas");
      canvas.className = "drawing";
      canvas.width = 800;
      canvas.height = 1100;
      page.appendChild(canvas);
      const ctx = canvas.getContext("2d");
      const img = new Image();
      img.src = p.imgData;
      img.onload = () => ctx.drawImage(img, 0, 0);
      p.texts.forEach(t => {
        const ta = document.createElement("textarea");
        ta.className = "note-text";
        ta.value = t.value;
        ta.style.left = t.left;
        ta.style.top = t.top;
        ta.style.width = t.width;
        ta.style.height = t.height;
        ta.style.fontSize = t.fontSize;
        ta.style.fontFamily = t.fontFamily;
        ta.style.fontWeight = t.fontWeight;
        ta.style.fontStyle = t.fontStyle;
        ta.style.textDecoration = t.textDecoration;
        page.appendChild(ta);
      });
      p.images.forEach(im => {
        const image = new Image();
        image.src = im.src;
        image.className = "draggable";
        image.style.left = im.left;
        image.style.top = im.top;
        page.appendChild(image);
        makeDraggable(image);
      });
      notebook.appendChild(page);
      setupDrawing(canvas);
    });
    if (notebook.children[0]) setActivePage(notebook.children[0]);
  }
  }
